<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" 
		 width="100%" height="100%" xmlns:local="*"
		 creationComplete="on_creation_complete(event)" xmlns:controls="controls.*"
		 initialize="on_initialize(event)"
>
<fx:Script>
<![CDATA[
	import flash.filesystem.File;
	import flash.utils.setTimeout;
	
	import mx.collections.ArrayCollection;
	import mx.core.IFlexDisplayObject;
	import mx.core.Window;
	import mx.events.CloseEvent;
	import mx.events.FlexEvent;
	import mx.managers.PopUpManager;
	
	import spark.components.Button;
	import spark.components.Group;
	import spark.components.Panel;
	import spark.components.TitleWindow;

	
public static var app:AppWindow;
[Bindable] public var engine:Engine = Engine.engine;
	
	
protected function on_initialize(event:FlexEvent):void
{
	app = this;	
}
	
	
protected function on_creation_complete(event:FlexEvent):void
{
	setTimeout(Engine.engine.open_database_connection, 500);
	
	dg_holder.addEventListener(MouseEvent.DOUBLE_CLICK, dg_double_click, true);
//	callLater(Engine.engine.open_database_connection, [""]);
//	Engine.engine.open_database_connection("");
}

[Bindable] private var dp:ArrayCollection = new ArrayCollection();



	
protected function btn_open_db_clickHandler(event:MouseEvent):void
{
//	var file:File = File.
	var fr:File = new File();
	fr.addEventListener(Event.SELECT, on_file_selected);
	
	var filter1:FileFilter = new FileFilter("DB Файлы (*.db, *.sqlite)", "*.db;*.sqlite"); 
	var filter2:FileFilter = new FileFilter("Все Файлы (*.*)", "*.*");
	
	fr.browseForOpen("", [filter1, filter2]);
}

protected function on_file_selected(e:Event):void
{
	var fr:File = e.target as File;
	
	fr.removeEventListener(Event.SELECT, on_file_selected);	

	var file_name:String = fr.nativePath;
	var disp_name:String = fr.name;
	
	engine.open_database_connection(file_name, disp_name);	
}	

public function change_item(item:Employee, fn:String, old_value:*):void
{
	engine.update_employee_field(item, fn, old_value);
}
	
	
[Bindable] protected var list_data:Object = { papa: this };	
	
protected var pi_update:int = -1; 
protected var dp_count:int = 0;
	
protected function btn_del_employee_clickHandler(event:MouseEvent):void
{
	if (dg.selectedIndex < 0) return;
	
	pi_update = dg.selectedIndex;
	
	var item:Employee = dg.selectedItem as Employee;
	
	engine.del_employee(item);
	engine.query_emploeyes();
}

protected function change_dp(v:int):Boolean
{
	if (dp_count == 0 && v != 0) {
		if (pi_update >= 0) {
			var len:int = (dg.dataProvider as ArrayCollection).length;
			if (pi_update >= len)
				pi_update = len - 1;
			//dg.selectedIndex = pi_update;
			callLater(dg_set_index, [pi_update]);
			
			pi_update = -1;
		}
	}
	
	dp_count = v;
	return true;
}

private function dg_set_index(i:int):void
{
	dg.selectedIndex = i;
	dg.scrollToIndex(dg.selectedIndex);
}
	
	
protected function dg_double_click(event:MouseEvent):void
{
	if (dg.selectedIndex < 0) return;
	Windows.windows.edit_employee(dg);
}
	
]]>
</fx:Script>
<mx:VBox width="100%" height="100%" paddingLeft="8" paddingRight="8" paddingTop="8" paddingBottom="8">
	
	<s:HGroup width="100%">
		<controls:BarButton id="btn_open_db" label="Открыть DB Файл" icon="{Icons.database}" click="btn_open_db_clickHandler(event)" />
		<s:Spacer width="40" />

		<controls:BarButton label="Отделения" click="{Windows.windows.departments()}" />		
		<controls:BarButton id="btn_add_employee" label="Добавить" icon="{Icons.add}" click="{Windows.windows.add_employee()}" enabled="{Engine.engine.f_connected}" />
		<controls:BarButton id="btn_del_employee" label="Уволить"  icon="{Icons.remove}" click="btn_del_employee_clickHandler(event)" enabled="{(dg.selectedIndex >= 0) &amp;&amp; f_db_ready}" />
		<s:Spacer width="40" />
		<controls:BarButton label="Правка" click="{Windows.windows.edit_employee(dg)}" icon="{Icons.data_edit}" />
		<s:Spacer width="100%" />
		
		<controls:BarButton label="SQLog" icon="{Icons.notebook}" click="{Windows.windows.sqlog()}"/>
		<s:Spacer width="20" />
		<controls:BarButton label="О программе" icon="{Icons.about}" click="{Windows.windows.about()}"/>		
	</s:HGroup>	
	
	<mx:HBox width="100%" height="100%">
		

	<mx:VBox width="100%" height="100%">
		
	<s:HGroup id="dg_holder" doubleClickEnabled="true" width="100%" height="100%">
	<controls:DataGridEx id="dg" width="100%" height="100%" minWidth="400" dataProvider="{engine.emp_dp}" columns="{columns}" user_data="{list_data}" />
	</s:HGroup>
		
	<mx:HBox width="100%" verticalAlign="middle" horizontalGap="2">
		<controls:BarButton width="40" icon="{Icons.media_beginning}" toolTip="Нач. Страница" click="{Engine.engine.query_emploeyes_page(0)}" enabled="{f_db_ready}" />
		<controls:BarButton width="40" icon="{Icons.media_rewind}" toolTip="&lt;&lt; Пред. Страница" click="{engine.query_emploeyes_page(-1)}" enabled="{f_db_ready}" />
		<controls:BarButton width="40" icon="{Icons.media_fast_forward}" toolTip="&gt;&gt; След. Страница" click="{engine.query_emploeyes_page( 1)}" enabled="{f_db_ready}" />
		<controls:BarButton width="40" icon="{Icons.media_end}" toolTip="Посл. Страница" click="{engine.query_emploeyes_page(int.MAX_VALUE)}" enabled="{f_db_ready}"  />
		<s:Spacer width="20" />
		<s:Label id="lbl_page" text="Страница : {Utils.fmt_int(engine.page_start + 1)} из {engine.page_total != 0 ? Utils.fmt_int(engine.page_total) : 1 }" paddingTop="4" minWidth="{lbl_page.width}"/>
		<s:Spacer width="100%" minWidth="20" />
		<s:Label id="lbl_rec" text="Кол-во записей : {Utils.fmt_int(engine.emp_dp.length)} / {Utils.fmt_int(engine.employee_num_records)}" paddingTop="4" minWidth="{lbl_rec.width}"/>		
		<s:Spacer width="20" />
		<controls:BarButton label="Обновить" click="{Engine.engine.query_emploeyes()}" enabled="{f_db_ready}" />
	</mx:HBox>
		
	</mx:VBox>		
	
	<local:FilterWindow />
	

		
		<!--<local:DepartmentsEditorWindow width="100%" height="100%" />-->
		
	</mx:HBox>

</mx:VBox>
	
<local:StatusBar />
	
<fx:Declarations>
<fx:Array id="columns">
	<mx:DataGridColumn headerText="ID" width="10" dataField="EmplID"/>
	<mx:DataGridColumn headerText="Имя" width="30" dataField="FirstName" itemRenderer="renderers.EmpEditItemRenderer"/>
	<mx:DataGridColumn headerText="Фамилия" width="30" dataField="LastName" itemRenderer="renderers.EmpEditItemRenderer"/>	
	<mx:DataGridColumn headerText="Отделение" width="30" dataField="DeptID" itemRenderer="renderers.DeptItemRenderer"/>
	<mx:DataGridColumn headerText="Должность" width="30" dataField="Position" itemRenderer="renderers.EmpEditItemRenderer"/>			
</fx:Array>
	
<fx:Boolean>{change_dp(Engine.engine.emp_dp.length)}</fx:Boolean>
	
<fx:Boolean id="f_db_ready">{engine.f_connected &amp;&amp; !engine.f_executing_sql_queue}</fx:Boolean>
	
</fx:Declarations>
</mx:VBox>
